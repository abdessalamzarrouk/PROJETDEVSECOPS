<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${operationRecette.numRecette != null ? 'Modifier Opération de Recette' : 'Ajouter Nouvelle Opération de Recette'}"></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .form-group label {
            font-weight: 600;
            color: #4a5568; /* gray-700 */
        }
        .form-control {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .form-control:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal min-h-screen flex flex-col">

<div class="flex flex-grow">
    <aside class="w-64 bg-gray-900 text-gray-200 flex-shrink-0 h-full sticky top-0 overflow-y-auto">
        <div class="w-full h-25 overflow-hidden flex items-center justify-center">
            <img th:src="@{/images/TGR-LOGO2.svg}" alt="Your Logo" class="w-full h-full object-cover">
        </div>
        <div class="p-6">
            <nav>
                <ul>
                    <li class="mb-2">
                        <a th:href="@{/comptable/dashboard}" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">Tableau de bord</a>
                    </li>
                    <li class="mb-2">
                        <a th:href="@{/bordereaux}" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">Bordereaux</a>
                    </li>
                    <li class="mb-2">
                        <a th:href="@{/articles-recette}" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">Articles de Recette</a>
                    </li>
                    <li class="mb-2">
                        <a th:href="@{/operations-recette}" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 bg-gray-700 hover:text-white">Opérations de Recette</a>
                    </li>
                    <li class="mb-2">
                        <a th:href="@{/rubriques-budgetaires}" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">Rubriques Budgétaires</a>
                    </li>
                    <li class="mb-2">
                        <a th:href="@{/reports}" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white">Rapports</a>
                    </li>
                    <li class="my-4 border-t border-gray-700"></li>
                    <li class="mb-2">
                        <a th:href="@{/profile}" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white text-white">Profil</a> </li>
                    <li>
                        <form th:action="@{/logout}" method="post" class="w-full">
                            <button type="submit" class="block w-full text-left py-2 px-4 rounded transition duration-200 hover:bg-red-700 hover:text-white text-red-300">
                                Déconnexion
                            </button>
                        </form>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>

    <main class="flex-1 p-4">
        <div class="container mx-auto p-6 bg-white rounded-lg shadow-xl mt-8">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h1 class="text-3xl font-bold text-gray-800" th:text="${operationRecette.numRecette != null ? 'Modifier Opération de Recette' : 'Ajouter Nouvelle Opération de Recette'}"></h1>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-600">Connecté en tant que :  <strong th:text="${connectedUserFullName ?: 'Invité'}" class="text-indigo-600"></strong></span>                    <form th:action="@{/logout}" method="post">
                        <button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-200">
                            Déconnexion
                        </button>
                    </form>
                </div>
            </div>

            <div th:if="${successMessage}" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
                <span class="block sm:inline" th:text="${successMessage}"></span>
            </div>
            <div th:if="${errorMessage}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <span class="block sm:inline" th:text="${errorMessage}"></span>
            </div>

            <form th:action="@{/operations-recette/save}" th:object="${operationRecette}" method="post" class="space-y-6">
                <input type="hidden" th:field="*{numRecette}" />

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label for="dateRecouv" class="block text-sm">Date de Recouvrement:</label>
                        <input type="date" id="dateRecouv" th:field="*{dateRecouv}" class="form-control" required/>
                    </div>

                    <div class="form-group">
                        <label for="dateValeurOP" class="block text-sm">Date Valeur Opération:</label>
                        <input type="date" id="dateValeurOP" th:field="*{dateValeurOP}" class="form-control" required/>
                    </div>

                    <div class="form-group">
                        <label for="dateOperation" class="block text-sm">Date Opération:</label>
                        <input type="date" id="dateOperation" th:field="*{dateOperation}" class="form-control" required/>
                    </div>

                    <div class="form-group">
                        <label for="montantRecette" class="block text-sm">Montant Recette:</label>
                        <input type="number" step="0.01" id="montantRecette" th:field="*{montantRecette}" class="form-control" required/>
                    </div>

                    <div class="form-group">
                        <label for="provenance" class="block text-sm">Provenance:</label>
                        <input type="text" id="provenance" th:field="*{provenance}" class="form-control" />
                    </div>

                    <div class="form-group">
                        <label for="etatRecette" class="block text-sm">État Recette:</label>
                        <select id="etatRecette" th:field="*{etatRecette}" class="form-control" required>
                            <option value="">Sélectionner l'état</option>
                            <option value="VALIDÉ">VALIDÉ</option>
                            <option value="EN_ATTENTE">EN_ATTENTE</option>
                            <option value="REJETÉ">REJETÉ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="montantMajoration" class="block text-sm">Montant Majoration:</label>
                        <input type="number" step="0.01" id="montantMajoration" th:field="*{montantMajoration}" class="form-control" />
                    </div>

                    <div class="form-group">
                        <label for="modePaiement" class="block text-sm">Mode de Paiement:</label>
                        <input type="text" id="modePaiement" th:field="*{modePaiement}" class="form-control" required/>
                    </div>

                    <div class="form-group">
                        <label for="articleRecette" class="block text-sm">Article de Recette:</label>
                        <select id="articleRecette" name="articleRecetteId" class="form-control" required>
                            <option value="">Sélectionner un Article de Recette</option>
                            <option th:each="article : ${articlesRecette}"
                                    th:value="${article.numArticleRecette}"
                                    th:text="${article.typeAR + ' (ID: ' + article.numArticleRecette + ', Montant: ' + article.montantAR + ')'}"
                                    th:selected="${operationRecette.articleRecette != null and operationRecette.articleRecette.numArticleRecette == article.numArticleRecette}">
                            </option>
                        </select>
                    </div>
                </div>

                <div class="form-group col-span-full">
                    <label for="observation" class="block text-sm">Observation:</label>
                    <textarea id="observation" th:field="*{observation}" rows="3" class="form-control"></textarea>
                </div>

                <div class="border p-4 rounded-lg bg-gray-50">
                    <h3 class="text-lg font-semibold mb-3">Informations Contribuable</h3>

                    <div class="mb-4">
                        <label class="block text-sm mb-2">Choisissez le contribuable:</label>
                        <div class="flex items-center space-x-4">
                            <input type="radio" id="contribuableNew" name="contribuableChoice" value="new"
                                   th:checked="${operationRecette.numRecette == null || selectedContribuableId == null}" class="mr-2">
                            <label for="contribuableNew">Nouveau Contribuable</label>

                            <input type="radio" id="contribuableExisting" name="contribuableChoice" value="existing"
                                   th:checked="${operationRecette.numRecette != null and selectedContribuableId != null}" class="mr-2">
                            <label for="contribuableExisting">Contribuable Existant</label>
                        </div>
                    </div>

                    <div id="newContribuableSection" style="display: none;" class="border-t pt-4 mt-4">
                        <h4 class="text-md font-semibold mb-3">Nouveau Contribuable</h4>
                        <div class="mb-4">
                            <label class="block text-sm mb-2">Type de Contribuable:</label>
                            <div class="flex items-center space-x-4">
                                <input type="radio" id="typePersonne" name="newContribuableType" value="P"
                                       th:checked="${selectedContribuableType == 'P'}" class="mr-2">
                                <label for="typePersonne">Personne Physique</label>

                                <input type="radio" id="typeSociete" name="newContribuableType" value="S"
                                       th:checked="${selectedContribuableType == 'S'}" class="mr-2">
                                <label for="typeSociete">Personne Morale (Société)</label>
                            </div>
                        </div>

                        <div id="personneFields" style="display: none;" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label for="p_cin" class="block text-sm">CIN:</label>
                                <input type="text" id="p_cin" name="p_cin" th:value="${personneContribuable.cinContribuable}" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label for="p_nom" class="block text-sm">Nom:</label>
                                <input type="text" id="p_nom" name="p_nom" th:value="${personneContribuable.nomContribuable}" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label for="p_prenom" class="block text-sm">Prénom:</label>
                                <input type="text" id="p_prenom" name="p_prenom" th:value="${personneContribuable.prenomContribuable}" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label for="p_adresseAuxiliaire" class="block text-sm">Adresse Auxiliaire:</label>
                                <input type="text" id="p_adresseAuxiliaire" name="p_adresseAuxiliaire" th:value="${personneContribuable.adresseAuxiliaire}" class="form-control" />
                            </div>
                        </div>

                        <div id="societeFields" style="display: none;" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label for="s_idFiscal" class="block text-sm">ID Fiscal:</label>
                                <input type="text" id="s_idFiscal" name="s_idFiscal" th:value="${societeContribuable.idFiscal}" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label for="s_raisonSociale" class="block text-sm">Raison Sociale:</label>
                                <input type="text" id="s_raisonSociale" name="s_raisonSociale" th:value="${societeContribuable.raisonSociale}" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label for="s_adresseFiscale" class="block text-sm">Adresse Fiscale:</label>
                                <input type="text" id="s_adresseFiscale" name="s_adresseFiscale" th:value="${societeContribuable.adresseFiscale}" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label for="s_typeOrganisme" class="block text-sm">Type Organisme:</label>
                                <input type="text" id="s_typeOrganisme" name="s_typeOrganisme" th:value="${societeContribuable.typeOrganisme}" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div id="existingContribuableSection" style="display: none;" class="border-t pt-4 mt-4">
                        <h4 class="text-md font-semibold mb-3">Contribuable Existant</h4>
                        <div class="form-group">
                            <label for="existingContribuable" class="block text-sm">Sélectionner un contribuable:</label>
                            <input type="text" id="searchContribuable" class="form-control" placeholder="Rechercher par CIN, Nom, Id Fiscal ou Raison Sociale..." />
                            <select id="existingContribuable" name="existingContribuableId" class="form-control mt-2">
                                <option value="">-- Choisir un contribuable --</option>
                                <option th:if="${operationRecette.contribuable != null}"
                                        th:value="${operationRecette.contribuable.idContribuable}"
                                        th:selected="true"
                                        th:text="${operationRecette.contribuable instanceof T(com.main.projetstage.models.PersonneContribuable) ?
                                                  operationRecette.contribuable.nomContribuable + ' ' + operationRecette.contribuable.prenomContribuable + ' (CIN: ' + operationRecette.contribuable.cinContribuable + ')' :
                                                  operationRecette.contribuable.raisonSociale + ' (ID Fiscal: ' + operationRecette.contribuable.idFiscal + ')'}">
                                    Selected Contribuable
                                </option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-4 mt-6">
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-200">
                        Sauvegarder l'Opération
                    </button>
                    <a th:href="@{/operations-recette}" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Annuler
                    </a>
                </div>
            </form>
        </div>
    </main>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/

    const contribuableNewRadio = document.getElementById('contribuableNew');
    const contribuableExistingRadio = document.getElementById('contribuableExisting');
    const newContribuableSection = document.getElementById('newContribuableSection');
    const existingContribuableSection = document.getElementById('existingContribuableSection');

    const typePersonneRadio = document.getElementById('typePersonne');
    const typeSocieteRadio = document.getElementById('typeSociete');
    const personneFields = document.getElementById('personneFields');
    const societeFields = document.getElementById('societeFields');

    const searchContribuableInput = document.getElementById('searchContribuable');
    const existingContribuableSelect = document.getElementById('existingContribuable');

    const operationRecetteNumRecette = /*[[${operationRecette.numRecette}]]*/ null;
    const initialSelectedContribuableType = /*[[${selectedContribuableType}]]*/ '';
    const initialSelectedContribuableId = /*[[${selectedContribuableId}]]*/ null;

    function toggleContribuableSections() {
        if (contribuableNewRadio.checked) {
            newContribuableSection.style.display = 'block';
            existingContribuableSection.style.display = 'none';
            // Enable inputs for new, disable for existing
            Array.from(newContribuableSection.querySelectorAll('input, select')).forEach(input => input.disabled = false);
            Array.from(existingContribuableSection.querySelectorAll('input, select')).forEach(input => input.disabled = true);
            toggleNewContribuableType(); // Ensure correct new contribuable fields are shown
        } else {
            newContribuableSection.style.display = 'none';
            existingContribuableSection.style.display = 'block';
            // Enable inputs for existing, disable for new
            Array.from(newContribuableSection.querySelectorAll('input, select')).forEach(input => input.disabled = true);
            Array.from(existingContribuableSection.querySelectorAll('input, select')).forEach(input => input.disabled = false);
        }
    }

    function toggleNewContribuableType() {
        if (typePersonneRadio.checked) {
            personneFields.style.display = 'grid';
            societeFields.style.display = 'none';
            // Enable Personne fields, disable Societe fields
            Array.from(personneFields.querySelectorAll('input')).forEach(input => input.disabled = false);
            Array.from(societeFields.querySelectorAll('input')).forEach(input => input.disabled = true);
        } else if (typeSocieteRadio.checked) {
            personneFields.style.display = 'none';
            societeFields.style.display = 'grid';
            // Enable Societe fields, disable Personne fields
            Array.from(personneFields.querySelectorAll('input')).forEach(input => input.disabled = true);
            Array.from(societeFields.querySelectorAll('input')).forEach(input => input.disabled = false);
        } else {
            // No type selected for new contribuable
            personneFields.style.display = 'none';
            societeFields.style.display = 'none';
            Array.from(personneFields.querySelectorAll('input')).forEach(input => input.disabled = true);
            Array.from(societeFields.querySelectorAll('input')).forEach(input => input.disabled = true);
        }
    }

    // Function to fetch and populate existing contribuables
    let searchTimeout;
    searchContribuableInput.addEventListener('keyup', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = searchContribuableInput.value;
            if (query.length >= 2) { // Fetch if query is at least 2 characters
                fetch(`/operations-recette/search-contribuables?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        existingContribuableSelect.innerHTML = '<option value="">-- Choisir un contribuable --</option>';
                        data.forEach(contribuable => {
                            let text = '';
                            if (contribuable.cinContribuable) { // Assuming PersonneContribuable
                                text = `${contribuable.nomContribuable} ${contribuable.prenomContribuable} (CIN: ${contribuable.cinContribuable})`;
                            } else if (contribuable.idFiscal) { // Assuming SocieteContribuable
                                text = `${contribuable.raisonSociale} (ID Fiscal: ${contribuable.idFiscal})`;
                            }
                            const option = document.createElement('option');
                            option.value = contribuable.idContribuable;
                            option.textContent = text;
                            existingContribuableSelect.appendChild(option);
                        });
                        // Pre-select if editing and matching current contribuable
                        if (initialSelectedContribuableId && contribuableExistingRadio.checked) {
                            existingContribuableSelect.value = initialSelectedContribuableId;
                        }
                    })
                    .catch(error => console.error('Error fetching contribuables:', error));
            } else if (query.length === 0) {
                // Clear results if search box is empty
                existingContribuableSelect.innerHTML = '<option value="">-- Choisir un contribuable --</option>';
                // If editing and existing contribuable was selected initially, re-add it
                if (initialSelectedContribuableId && contribuableExistingRadio.checked) {
                    const selectedOption = document.createElement('option');
                    selectedOption.value = initialSelectedContribuableId;
                    // This text needs to come from the model or be dynamically set again
                    // For simplicity, we'll just put a placeholder here, a more robust solution might fetch it by ID.
                    selectedOption.textContent = "Contribuable sélectionné (ID: " + initialSelectedContribuableId + ")";
                    selectedOption.selected = true;
                    existingContribuableSelect.appendChild(selectedOption);
                }
            }
        }, 300); // Debounce search input
    });


    // Event Listeners
    contribuableNewRadio.addEventListener('change', toggleContribuableSections);
    contribuableExistingRadio.addEventListener('change', toggleContribuableSections);
    typePersonneRadio.addEventListener('change', toggleNewContribuableType);
    typeSocieteRadio.addEventListener('change', toggleNewContribuableType);


    // Initial state setup on page load
    document.addEventListener('DOMContentLoaded', () => {
        toggleContribuableSections(); // Initialize new/existing sections

        // For edit mode, pre-select the correct contribuable type if any
        if (operationRecetteNumRecette != null && initialSelectedContribuableId != null) {
            if (initialSelectedContribuableType === 'P') {
                typePersonneRadio.checked = true;
            } else if (initialSelectedContribuableType === 'S') {
                typeSocieteRadio.checked = true;
            }
            toggleNewContribuableType(); // Show correct new contribuable fields if applicable

            // If an existing contribuable is pre-selected, trigger a search to populate the dropdown
            if (contribuableExistingRadio.checked) {
                // Fetch the initially selected contribuable to ensure it's in the dropdown
                // This is a simplified approach, a better one would ensure the specific contribuable is loaded
                // or the dropdown is pre-populated with it during the initial controller model setup.
                // For now, let's assume `searchContribuable` might be used to find it.
                // Or you pass the current contribuable's full details and dynamically add it as a selected option.
                // The current HTML already has a `th:if` block for a pre-selected option.
            }
        }
    });

    /*]]>*/
</script>
</body>
</html>